# FinFlow Split Service (ff-split)

## Описание
FinFlow Split Service (ff-split) - это сервис для управления групповыми расходами и мероприятиями в экосистеме FinFlow. Сервис предоставляет API для создания и управления мероприятиями, учета расходов между участниками, и расчета задолженностей.

## Функциональность

- **Управление категориями мероприятий**
- **Создание и управление мероприятиями**
- **Отслеживание активностей в мероприятиях**
- **Управление транзакциями и расходами**
- **Расчет задолженностей между участниками**
- **Управление типами транзакций и иконками**

## Технический стек

- **Язык:** Go
- **Фреймворк:** Gin (HTTP-сервер)
- **База данных:** PostgreSQL
- **ORM:** GORM
- **Миграции:** golang-migrate
- **Развертывание:** Docker, Docker Compose

## Архитектура

### Структура проекта

```
ff-split/
├── cmd/                # Точки входа в приложение
│   └── app/            # Основное приложение
├── config/             # Конфигурационные файлы
│   └── config.yaml      # Конфигурация сервиса
├── internal/           # Внутренний код приложения
│   ├── api/            # API компоненты
│   │   ├── handler/    # Обработчики HTTP-запросов
│   │   └── middleware/ # Промежуточные обработчики
│   ├── adapters/       # Адаптеры внешних сервисов
│   │   ├── id/         # Адаптер для ff-id
│   │   └── files/      # Адаптер для ff-files
│   ├── app/            # Ядро приложения
│   ├── common/         # Общие компоненты
│   │   └── config/     # Конфигурация приложения
│   ├── models/         # Модели данных
│   ├── repository/     # Слой доступа к данным
│   │   └── postgres/   # Реализация на PostgreSQL
│   └── service/        # Бизнес-логика
│       ├── event/      # Сервис мероприятий
│       ├── transaction/ # Сервис транзакций
│       ├── debt/       # Сервис расчета долгов
│       └── category/   # Сервис категорий
├── pkg/                # Публичные пакеты
│   ├── api/            # API спецификация
│   └── client/         # Клиенты для других сервисов
├── tests/              # Тесты
│   ├── base_suite.go   # Базовый набор тестов
│   ├── event_test.go   # Тесты мероприятий
│   ├── transaction_test.go # Тесты транзакций
│   └── migrations.sql  # SQL для тестов
├── docs/               # Документация
│   ├── docs.go         # Swagger документация
│   └── swagger.yaml    # OpenAPI спецификация
├── Makefile            # Команды для разработки
├── Dockerfile          # Docker образ
└── docker-compose.yml  # Docker Compose конфигурация
```

### Архитектурные слои

1. **API Layer** - HTTP обработчики, валидация запросов, обработка ответов
2. **Service Layer** - Бизнес-логика: управление мероприятиями, транзакциями, расчет долгов
3. **Repository Layer** - Доступ к данным, работа с PostgreSQL
4. **Adapter Layer** - Интеграция с внешними сервисами (ff-id, ff-files, ff-tvm)

### Взаимодействие с другими сервисами

- **ff-id** - получение данных о пользователях по ID, синхронизация профилей
- **ff-files** - загрузка и получение чеков для транзакций
- **ff-tvm** - получение TVM тикетов для межсервисного взаимодействия
- **ff-auth** - валидация JWT токенов для доступа к API

### Ключевые алгоритмы

#### Расчет долгов

Сервис использует несколько стратегий разделения расходов:
- **Процентное распределение (percent)** - расходы делятся по процентам
- **Фиксированные суммы (amount)** - каждому участнику назначается фиксированная сумма
- **Распределение по долям (units)** - расходы делятся по долям участников

#### Оптимизация долгов

Сервис автоматически оптимизирует долги между участниками:
1. Расчет общего баланса каждого участника
2. Группировка на должников и кредиторов
3. Минимизация количества переводов
4. Генерация оптимальных схем погашения

## API Endpoints

### Категории

```
GET  /api/v1/category        # Получить все категории
GET  /api/v1/category/{id}   # Получить категорию по ID
POST /api/v1/category        # Создать новую категорию
PUT  /api/v1/category/{id}   # Обновить категорию
DEL  /api/v1/category/{id}   # Удалить категорию
```

### Мероприятия

```
GET  /api/v1/events                     # Получить все мероприятия
GET  /api/v1/event/{id}                 # Получить мероприятие по ID
POST /api/v1/event                      # Создать новое мероприятие
PUT  /api/v1/event/{id}                 # Обновить мероприятие
DEL  /api/v1/event/{id}                 # Удалить мероприятие
```

### Активности мероприятий

```
GET  /api/v1/event/{id_event}/activity          # Получить все активности мероприятия
GET  /api/v1/event/{id_event}/activity/{id}     # Получить активность по ID
POST /api/v1/event/{id_event}/activity          # Создать новую активность
PUT  /api/v1/event/{id_event}/activity/{id}     # Обновить активность
DEL  /api/v1/event/{id_event}/activity/{id}     # Удалить активность
```

### Транзакции

```
GET  /api/v1/event/{id_event}/transactions      # Получить все транзакции мероприятия
GET  /api/v1/event/{id_event}/transactions/temporal  # Получить итоговые задолженности
```

### Управление (требуется роль service_admin)

```
GET  /api/v1/manage/transaction_type        # Получить все типы транзакций
POST /api/v1/manage/transaction_type        # Создать новый тип транзакции

GET  /api/v1/manage/icons                   # Получить все иконки
POST /api/v1/manage/icons                   # Загрузить новую иконку
```

## Быстрый старт

### Предварительные требования

- Go 1.19 или выше
- PostgreSQL 13 или выше
- Redis (опционально, для кэширования)
- Docker и Docker Compose (опционально)

### Настройка окружения

1. Клонировать репозиторий:
```bash
git clone https://github.com/ivasnev/FinFlow.git
cd FinFlow/FinFlowBackend/ff-split
```

2. Настроить конфигурацию:
```bash
cp config/config.yaml config/config.yaml.local
# Отредактировать config.yaml.local под свои настройки
```

Основные параметры конфигурации:
- `server.port` - порт сервиса (по умолчанию 8085)
- `postgres.*` - параметры подключения к PostgreSQL
- `redis.*` - параметры подключения к Redis (если используется)
- `auth.*` - настройки интеграции с ff-auth
- `id_service.*` - настройки интеграции с ff-id
- `file_service.*` - настройки интеграции с ff-files
- `tvm.*` - настройки TVM для межсервисной авторизации

### Запуск с Docker Compose

```bash
docker-compose up -d
```

Это запустит:
- Сервис ff-split
- PostgreSQL (если не используется внешний)
- Redis (если не используется внешний)

### Локальный запуск

1. Убедитесь, что PostgreSQL запущен:
```bash
# Создать базу данных
psql -U postgres -c "CREATE DATABASE ff_split;"
```

2. Примените миграции:
```bash
# Используя golang-migrate
migrate -path internal/repository/migrations \
  -database "postgres://postgres:postgres@localhost:5432/ff_split?sslmode=disable" \
  up
```

3. Установите зависимости:
```bash
go mod download
```

4. Запустите сервис:
```bash
# Через Makefile
make run

# Или напрямую
go run cmd/app/main.go
```

Сервис будет доступен по адресу `http://localhost:8085`

## Разработка

### Сборка проекта
```
make build
```

### Запуск тестов
```
make test
```

### Запуск линтера
```
make lint
```

### Запуск в режиме разработки (hot-reload)
```
make dev
``` 